<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tax Trek: Australia’s Global Minimum Tax Challenge</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #005566;
    }
    button.lesson-button,
    button.choice,
    #next-exercise {
      display: block;
      margin: 10px auto;
      padding: 15px;
      background: #005566;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      width: 80%;
      max-width: 400px;
      text-align: center;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    button.lesson-button:hover,
    button.choice:hover,
    #next-exercise:hover,
    button.lesson-button:focus,
    button.choice:focus,
    #next-exercise:focus {
      background: #003d4a;
      outline: none;
      box-shadow: 0 0 0 3px #66a3ad;
    }
    button.choice {
      background: #eee;
      color: #333;
      border: 1px solid #ddd;
      width: 80%;
      max-width: 400px;
      padding: 10px;
      margin: 8px auto;
      cursor: pointer;
    }
    button.choice.correct {
      background-color: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
      cursor: default;
    }
    button.choice.incorrect {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
      cursor: default;
    }
    button.submit-btn {
      background: #005566;
      color: #fff;
      margin-top: 10px;
      width: 80%;
      max-width: 400px;
    }
    button.submit-btn:hover, button.submit-btn:focus {
      background: #003d4a;
      box-shadow: 0 0 0 3px #66a3ad;
    }
    input[type="text"] {
      width: 80%;
      max-width: 400px;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    #feedback {
      margin: 15px 0;
      padding: 12px;
      border-radius: 5px;
      font-weight: bold;
      min-height: 40px;
      aria-live: polite;
    }
    #feedback.correct {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    #feedback.incorrect {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #stats, #stats-lesson {
      margin: 10px 0;
      font-weight: bold;
      font-size: 1.1rem;
    }
    #next-exercise {
      margin-top: 20px;
      width: auto;
      padding: 12px 25px;
      font-weight: bold;
    }
    #progress {
      margin-top: 10px;
      font-size: 1rem;
      color: #005566;
    }
    #completion {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #d4edda;
      border-radius: 5px;
    }
    #recap-quiz {
      display: none;
      margin-top: 20px;
    }
    #exit-lesson {
      margin-top: 15px;
      background: #999;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      width: auto;
    }
    #exit-lesson:hover, #exit-lesson:focus {
      background: #666;
      outline: none;
      box-shadow: 0 0 0 3px #999;
    }
    @media (max-width: 600px) {
      button.lesson-button, button.choice, input[type="text"], button.submit-btn {
        width: 100%;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="home" aria-label="Home screen with lessons">
    <h1>Tax Trek</h1>
    <p>Australia’s Global Minimum Tax Challenge</p>
    <div id="stats" aria-live="polite">
      <span id="hearts">Hearts: 5</span> | <span id="xp">XP: 0</span> | <span id="streak">Streak: 0 days</span>
    </div>
    <h2>Lessons</h2>
    <!-- Lesson buttons will be added here -->
  </div>

  <div class="container" id="lesson" style="display:none;" aria-label="Lesson view">
    <h1 id="lesson-title"></h1>
    <div id="stats-lesson" aria-live="polite">
      <span id="hearts-lesson">Hearts: 5</span> | <span id="xp-lesson">XP: 0</span>
    </div>
    <div id="progress"></div>
    <div class="exercise" id="exercise-content" role="region" aria-live="polite" aria-atomic="true"></div>
    <div id="feedback" aria-live="polite"></div>
    <button id="next-exercise" style="display:none;">Next Exercise</button>
    <button id="exit-lesson">Exit Lesson</button>
    <div id="completion"></div>
    <div id="recap-quiz"></div>
  </div>

  <script>
    // ===== Data =====
    const lessons = [
      {
        title: "Basics of Pillar 2",
        exercises: [
          {
            type: "tf",
            question: "True or False: Pillar 2 applies to MNEs with consolidated annual revenue of €750m or more in at least two of the four preceding fiscal years.",
            answer: true,
            explanation: "True. [Taxation (Multinational—Global and Domestic Minimum Tax) Act 2024, Section 5]"
          },
          {
            type: "mc",
            question: "What is the minimum tax rate under Pillar 2?",
            options: ["10%", "15%", "20%", "25%"],
            answer: "15%",
            explanation: "15%. [Taxation (Multinational—Global and Domestic Minimum Tax) Act 2024, Section 10]"
          },
          {
            type: "fib",
            question: "The global minimum tax is implemented through the ______ Rules.",
            answer: "GloBE",
            explanation: "GloBE Rules. [Taxation (Multinational—Global and Domestic Minimum Tax) Act 2024, Section 12]"
          }
        ]
      },
      {
        title: "Scope and Application",
        exercises: [
          {
            type: "mc",
            question: "Pillar 2 applies to fiscal years starting on or after which date for IIR and DMT?",
            options: ["January 1, 2023", "January 1, 2024", "January 1, 2025", "January 1, 2026"],
            answer: "January 1, 2024",
            explanation: "January 1, 2024. [Taxation (Multinational—Global and Domestic Minimum Tax) Act 2024, Section 7]"
          },
          {
            type: "tf",
            question: "True or False: The scope is MNEs with €750m+ revenue in 2 of 4 prior fiscal years.",
            answer: true,
            explanation: "True. [Taxation (Multinational—Global and Domestic Minimum Tax) Act 2024, Section 5]"
          },
          {
            type: "fib",
            question: "The Act is called Taxation (Multinational—Global and Domestic Minimum Tax) Act _____.",
            answer: "2024",
            explanation: "2024."
          }
        ]
      }
      // Add other lessons similarly...
    ];

    // ===== State =====
    let currentLesson = 0;
    let currentExercise = 0;
    let hearts = 5;
    let xp = 0;
    let streak = 0;
    const dailyGoal = 50; // XP needed for daily reward
    const maxHearts = 5;

    // Local Storage Keys
    const storageKeys = {
      xp: 'taxTrek_xp',
      streak: 'taxTrek_streak',
      lastDay: 'taxTrek_lastDay',
      hearts: 'taxTrek_hearts'
    };

    // ===== Load and Save Progress =====
    function loadProgress() {
      xp = parseInt(localStorage.getItem(storageKeys.xp)) || 0;
      streak = parseInt(localStorage.getItem(storageKeys.streak)) || 0;
      hearts = parseInt(localStorage.getItem(storageKeys.hearts)) || maxHearts;
      const lastDay = localStorage.getItem(storageKeys.lastDay);
      const today = new Date().toDateString();

      if (!lastDay) {
        streak = 1;
      } else {
        const lastDate = new Date(lastDay);
        const diffTime = new Date(today) - lastDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays === 1) {
          streak++;
          if (streak % 3 === 0) hearts = Math.min(hearts + 1, maxHearts);
        } else if (diffDays > 1) {
          streak = 1;
          hearts = maxHearts;
        }
      }
      localStorage.setItem(storageKeys.lastDay, today);
      localStorage.setItem(storageKeys.streak, streak);
      localStorage.setItem(storageKeys.hearts, hearts);
      updateStats();
    }

    function saveProgress() {
      localStorage.setItem(storageKeys.xp, xp);
      localStorage.setItem(storageKeys.streak, streak);
      localStorage.setItem(storageKeys.hearts, hearts);
    }

    // ===== UI Updates =====
    function updateStats() {
      document.getElementById('hearts').textContent = `Hearts: ${hearts}`;
      document.getElementById('xp').textContent = `XP: ${xp} / ${dailyGoal} (Goal)`;
      document.getElementById('streak').textContent = `Streak: ${streak} days`;
      if (document.getElementById('hearts-lesson') && document.getElementById('xp-lesson')) {
        document.getElementById('hearts-lesson').textContent = `Hearts: ${hearts}`;
        document.getElementById('xp-lesson').textContent = `XP: ${xp} / ${dailyGoal} (Goal)`;
      }
      saveProgress();
    }

    function displayLessons() {
      const home = document.getElementById('home');
      // Remove old buttons if any
      home.querySelectorAll('button.lesson-button').forEach(btn => btn.remove());
      lessons.forEach((lesson, index) => {
        const button = document.createElement('button');
        button.className = 'lesson-button';
        button.textContent = lesson.title;
        button.setAttribute('aria-label', `Start lesson: ${lesson.title}`);
        button.onclick = () => startLesson(index);
        home.appendChild(button);
      });
    }

    function startLesson(lessonIndex) {
      currentLesson = lessonIndex;
      currentExercise = 0;
      document.getElementById('home').style.display = 'none';
      document.getElementById('lesson').style.display = 'block';
      document.getElementById('lesson-title').textContent = lessons[currentLesson].title;
      displayExercise();
    }

    function displayExercise() {
      const exercise = lessons[currentLesson].exercises[currentExercise];
      const content = document.getElementById('exercise-content');
      const feedback = document.getElementById('feedback');
      const nextBtn = document.getElementById('next-exercise');
      const progress = document.getElementById('progress');
      const recapQuiz = document.getElementById('recap-quiz');

      content.innerHTML = `<p>${exercise.question}</p>`;
      feedback.textContent = '';
      feedback.className = '';
      nextBtn.style.display = 'none';
      progress.textContent = `Exercise ${currentExercise + 1} of ${lessons[currentLesson].exercises.length}`;
      recapQuiz.style.display = 'none';
      recapQuiz.innerHTML = '';

      if (exercise.type === "tf") {
        ['True', 'False'].forEach(val => {
          const btn = document.createElement('button');
          btn.className = 'choice';
          btn.textContent = val;
          btn.setAttribute('aria-pressed', 'false');
          btn.onclick = () => checkAnswer(val === 'True');
          content.appendChild(btn);
        });
      } else if (exercise.type === "mc") {
        exercise.options.forEach(option => {
          const btn = document.createElement('button');
          btn.className = 'choice';
          btn.textContent = option;
          btn.setAttribute('aria-pressed', 'false');
          btn.onclick = () => checkAnswer(option);
          content.appendChild(btn);
        });
      } else if (exercise.type === "fib") {
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'fib-input';
        input.setAttribute('aria-label', 'Fill in the blank answer');
        content.appendChild(input);

        const submitBtn = document.createElement('button');
        submitBtn.textContent = 'Submit Answer';
        submitBtn.className = 'submit-btn';
        submitBtn.onclick = () => {
          const userAnswer = input.value.trim();
          if (!userAnswer) {
            alert("Please enter an answer before submitting.");
            input.focus();
            return;
          }
          checkAnswer(userAnswer);
        };
        content.appendChild(submitBtn);

        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') submitBtn.click();
        });
        input.focus();
      }
    }

    function checkAnswer(userAnswer) {
      const exercise = lessons[currentLesson].exercises[currentExercise];
      const feedback = document.getElementById('feedback');
      const nextBtn = document.getElementById('next-exercise');
      const content = document.getElementById('exercise-content');
      const choices = content.querySelectorAll('button.choice');
      const input = document.getElementById('fib-input');

      // Determine correctness
      let isCorrect;
      if (exercise.type === 'fib') {
        isCorrect = userAnswer.toLowerCase() === exercise.answer.toLowerCase();
      } else if (exercise.type === 'tf' || exercise.type === 'mc') {
        isCorrect = userAnswer === exercise.answer;
      } else {
        isCorrect = false;
      }

      // Show feedback with explanation
      feedback.className = isCorrect ? 'correct' : 'incorrect';
      feedback.textContent = (isCorrect ? "Correct! " : "Incorrect. ") + exercise.explanation;

      // Disable all choices and style
      choices.forEach(btn => {
        btn.disabled = true;
        if (isCorrect && btn.textContent === userAnswer.toString()) {
          btn.classList.add('correct');
        } else if (!isCorrect && btn.textContent === userAnswer.toString()) {
          btn.classList.add('incorrect');
        }
      });

      // Disable input and submit button for FIB
      if (input) {
        input.disabled = true;
        const submitBtn = content.querySelector('button.submit-btn');
        if (submitBtn) submitBtn.disabled = true;
      }

      // Update XP and hearts
      if (isCorrect) {
        xp += 10;
        if (xp >= dailyGoal && streak > 0) {
          xp = xp % dailyGoal;
          alert("Daily goal reached! +1 Heart (max 5)");
          hearts = Math.min(hearts + 1, maxHearts);
        }
      } else {
        hearts--;
      }
      updateStats();

      if (hearts <= 0) {
        displayRecapQuiz();
        nextBtn.style.display = 'none';
        return;
      }

      // Show next button
      nextBtn.style.display = 'inline-block';
      nextBtn.focus();
    }

    function displayRecapQuiz() {
      const recapQuiz = document.getElementById('recap-quiz');
      const exercise = lessons[currentLesson].exercises[currentExercise];
      recapQuiz.style.display = 'block';
      recapQuiz.innerHTML = `
        <p>Out of hearts! Complete this recap to restore 2 hearts.</p>
        <p>Question: What is the key rule related to "${exercise.question.split('?')[0]}"?</p>
        <button class="choice" onclick="checkRecap('€750m or more')">€750m or more</button>
        <button class="choice" onclick="checkRecap('15% minimum tax')">15% minimum tax</button>
        <button class="choice" onclick="checkRecap('GloBE Rules')">GloBE Rules</button>
      `;
    }

    function checkRecap(answer) {
      const recapQuiz = document.getElementById('recap-quiz');
      const feedback = document.createElement('div');
      feedback.id = 'feedback';
      const correctKey = lessons[currentLesson].exercises[currentExercise].explanation.match(/€750m|15%|GloBE/)[0];
      const isCorrect = answer.includes(correctKey) || correctKey.includes(answer);

      feedback.className = isCorrect ? 'correct' : 'incorrect';
      feedback.textContent = isCorrect ? "Correct! Restoring 2 hearts." : "Incorrect. Try again or exit.";
      recapQuiz.appendChild(feedback);

      if (isCorrect) {
        hearts = Math.min(hearts + 2, maxHearts);
        updateStats();
        setTimeout(() => {
          recapQuiz.style.display = 'none';
          feedback.remove();
          displayExercise();
        }, 1200);
      } else {
        setTimeout(() => {
          if (confirm("Failed recap. Exit lesson?")) {
            returnToHome();
          } else {
            feedback.remove();
          }
        }, 1200);
      }
    }

    document.getElementById('next-exercise').addEventListener('click', () => {
      currentExercise++;
      if (currentExercise >= lessons[currentLesson].exercises.length) {
        const bonusXp = 50;
        xp += bonusXp;
        const completion = document.getElementById('completion');
        completion.style.display = 'block';
        completion.innerHTML = `<p>🎉 Congratulations! Lesson completed! +${bonusXp} XP</p><button onclick="returnToHome()">Continue</button>`;
        updateStats();
        document.getElementById('exercise-content').innerHTML = '';
        document.getElementById('feedback').textContent = '';
        document.getElementById('next-exercise').style.display = 'none';
      } else {
        displayExercise();
      }
    });

    document.getElementById('exit-lesson').addEventListener('click', () => {
      if (confirm('Are you sure you want to exit the lesson? Your progress in this lesson will be lost.')) {
        returnToHome();
      }
    });

    function returnToHome() {
      document.getElementById('lesson').style.display = 'none';
      document.getElementById('home').style.display = 'block';
      hearts = Math.min(hearts, maxHearts);
      updateStats();
      document.getElementById('completion').style.display = 'none';
      document.getElementById('recap-quiz').style.display = 'none';
      document.getElementById('feedback').textContent = '';
      document.getElementById('exercise-content').innerHTML = '';
      document.getElementById('next-exercise').style.display = 'none';
    }

    // ===== Initialize =====
    loadProgress();
    displayLessons();
  </script>
</body>
</html>
